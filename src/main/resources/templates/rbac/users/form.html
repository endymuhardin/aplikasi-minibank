<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${user.id != null} ? 'Edit User' : 'Create User'">User Form</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="flex justify-between items-center mb-6">
            <h1 id="page-title" class="text-3xl font-bold text-bsi-darker" 
                th:text="${user.id != null} ? 'Edit User' : 'Create User'">User Form</h1>
            <a th:href="@{/rbac/users/list}" 
               class="bg-bsi-light-gray hover:bg-bsi-gray text-white font-bold py-2 px-4 rounded"
               id="back-to-list-btn">
                Back to List
            </a>
        </div>

        <!-- Error Messages -->
        <div th:if="${errorMessage}" 
             class="bg-bsi-secondary bg-opacity-20 border border-bsi-secondary text-bsi-secondary px-4 py-3 rounded mb-4"
             id="error-message">
            <span th:text="${errorMessage}"></span>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
            <form th:action="${user.id != null} ? @{/rbac/users/edit/{id}(id=${user.id})} : @{/rbac/users/create}" 
                  method="post" 
                  th:object="${user}"
                  id="user-form">
                
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <!-- Username -->
                    <div>
                        <label for="username" class="block text-sm font-medium text-bsi-dark">Username *</label>
                        <input type="text" 
                               id="username" 
                               th:field="*{username}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-bsi-primary focus:border-bsi-primary"
                               th:classappend="${#fields.hasErrors('username')} ? 'border-bsi-secondary' : ''"
                               required>
                        <p th:if="${#fields.hasErrors('username')}" 
                           th:errors="*{username}" 
                           class="mt-1 text-sm text-bsi-secondary username-error"
                           id="username-error"></p>
                    </div>

                    <!-- Full Name -->
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-bsi-dark">Full Name *</label>
                        <input type="text" 
                               id="fullName" 
                               th:field="*{fullName}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-bsi-primary focus:border-bsi-primary"
                               th:classappend="${#fields.hasErrors('fullName')} ? 'border-bsi-secondary' : ''"
                               required>
                        <p th:if="${#fields.hasErrors('fullName')}" 
                           th:errors="*{fullName}" 
                           class="mt-1 text-sm text-bsi-secondary fullname-error"
                           id="fullname-error"></p>
                    </div>

                    <!-- Email -->
                    <div class="sm:col-span-2">
                        <label for="email" class="block text-sm font-medium text-bsi-dark">Email *</label>
                        <input type="email" 
                               id="email" 
                               th:field="*{email}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-bsi-primary focus:border-bsi-primary"
                               th:classappend="${#fields.hasErrors('email')} ? 'border-bsi-secondary' : ''"
                               required>
                        <p th:if="${#fields.hasErrors('email')}" 
                           th:errors="*{email}" 
                           class="mt-1 text-sm text-bsi-secondary email-error"
                           id="email-error"></p>
                    </div>

                    <!-- Branch Selection -->
                    <div class="sm:col-span-2">
                        <label for="branch" class="block text-sm font-medium text-bsi-dark">Branch *</label>
                        <select id="branch" 
                                name="branch.id" 
                                th:field="*{branch.id}"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-bsi-primary focus:border-bsi-primary"
                                th:classappend="${#fields.hasErrors('branch')} ? 'border-bsi-secondary' : ''"
                                required>
                            <option value="">Select Branch</option>
                            <option th:each="branch : ${availableBranches}" 
                                    th:value="${branch.id}" 
                                    th:text="${branch.getDisplayName()}">
                            </option>
                        </select>
                        <p th:if="${#fields.hasErrors('branch')}" 
                           th:errors="*{branch}" 
                           class="mt-1 text-sm text-bsi-secondary branch-error"
                           id="branch-error"></p>
                        <p class="mt-1 text-sm text-gray-500">Select the branch where this user will be assigned</p>
                    </div>

                    <!-- Password will be handled separately after user creation -->

                    <!-- Active Status (only for edit) -->
                    <div th:if="${user.id != null}">
                        <label for="isActive" class="flex items-center">
                            <input type="checkbox" 
                                   id="isActive" 
                                   th:field="*{isActive}"
                                   class="h-4 w-4 text-bsi-primary focus:ring-bsi-primary border-gray-300 rounded">
                            <span class="ml-2 text-sm font-medium text-bsi-dark">Active</span>
                        </label>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <a th:href="@{/rbac/users/list}" 
                       class="bg-bsi-bg-light hover:bg-gray-400 text-bsi-dark font-bold py-2 px-4 rounded"
                       id="cancel-btn">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="bg-bsi-primary hover:bg-bsi-teal text-white font-bold py-2 px-4 rounded"
                            id="save-user-btn">
                        <span th:text="${user.id != null} ? 'Update User' : 'Create User'">Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>