<html
	lang="en"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}"
>
	<head>
		<title>Direct Passbook Printing - Minibank</title>
	</head>
	<body>
		<div layout:fragment="content" class="container mx-auto px-4 py-8">
			<div class="bg-white rounded-lg shadow-lg p-6">
				<div class="flex justify-between items-center mb-6">
					<h1 id="page-title" class="text-2xl font-bold text-gray-800">Passbook Printing (ESC-POS)</h1>
					<div class="flex space-x-2">
						<a
							th:href="@{/passbook/select-account}"
							id="back-to-selection-button"
							class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded"
						>
							Back to Selection
						</a>
					</div>
				</div>

				<!-- Success Message -->
				<div
					th:if="${successMessage}"
					id="success-message"
					class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"
				>
					<span th:text="${successMessage}"></span>
				</div>

				<!-- ESC-POS Printer Manager warning -->
				<div id="browser-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
					<div class="flex">
						<svg
							class="h-5 w-5 text-red-400 mt-0.5 mr-3"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"
							></path>
						</svg>
						<div>
							<h3 class="text-sm font-medium text-red-800">ESC-POS Printer Manager Not Running</h3>
							<p id="browser-warning-text" class="text-sm text-red-700 mt-1">
								ESC-POS Printer Manager is not running or no printers configured. Please start the
								application and configure your printer.
							</p>
						</div>
					</div>
				</div>

				<!-- Account information card -->
				<div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
						<div>
							<h3 class="text-sm font-medium text-blue-800 mb-2">Account Details</h3>
							<p class="text-sm">
								<strong>Account Number:</strong>
								<span id="account-number" th:text="${account.accountNumber}">A2000001</span>
							</p>
							<p class="text-sm">
								<strong>Account Name:</strong>
								<span th:text="${account.accountName}">Account Name</span>
							</p>
							<p class="text-sm">
								<strong>Product:</strong>
								<span th:text="${account.product.productName}">Product Name</span>
							</p>
						</div>
						<div>
							<h3 class="text-sm font-medium text-blue-800 mb-2">Customer Details</h3>
							<p class="text-sm">
								<strong>Customer:</strong>
								<span th:text="${account.customer.displayName}">Customer Name</span>
							</p>
							<p class="text-sm">
								<strong>Customer Number:</strong>
								<span th:text="${account.customer.customerNumber}">C1000001</span>
							</p>
							<p class="text-sm">
								<strong>Current Balance:</strong>
								<span class="font-medium"
									>IDR
									<span th:text="${#numbers.formatDecimal(account.balance, 0, 'COMMA', 2, 'POINT')}"
										>0.00</span
									></span
								>
							</p>
						</div>
						<div>
							<h3 class="text-sm font-medium text-blue-800 mb-2">Passbook Status</h3>
							<p class="text-sm">
								<strong>Passbook No:</strong> <span id="passbook-number">Loading...</span>
							</p>
							<p class="text-sm"><strong>Current Page:</strong> <span id="current-page">-</span></p>
							<p class="text-sm">
								<strong>Last Printed Line:</strong> <span id="last-printed-line">-</span>
							</p>
							<p class="text-sm"><strong>Remaining Lines:</strong> <span id="remaining-lines">-</span></p>
						</div>
					</div>
				</div>

				<!-- Printer connection status -->
				<div class="bg-gray-50 rounded-lg p-4 mb-6">
					<div class="flex items-center justify-between">
						<div class="flex items-center">
							<div id="printer-status-icon" class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
							<div>
								<h3 class="text-sm font-medium text-gray-800">Printer Status</h3>
								<p id="printer-status-text" class="text-sm text-gray-600">Not connected</p>
							</div>
						</div>
						<button
							id="connect-printer-btn"
							class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded disabled:bg-gray-400 disabled:cursor-not-allowed"
						>
							Connect Printer
						</button>
					</div>
				</div>

				<!-- Unprinted transactions info -->
				<div id="unprinted-info" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
					<div class="flex items-center justify-between">
						<div class="flex items-center">
							<svg
								class="h-5 w-5 text-yellow-400 mr-3"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
								></path>
							</svg>
							<div>
								<h3 class="text-sm font-medium text-yellow-800">Unprinted Transactions</h3>
								<p id="unprinted-count" class="text-sm text-yellow-700">Checking...</p>
							</div>
						</div>
						<button id="refresh-status-btn" class="text-yellow-700 hover:text-yellow-900 text-sm underline">
							Refresh
						</button>
					</div>
				</div>

				<!-- Print controls -->
				<div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
					<h3 class="text-lg font-medium text-green-800 mb-4">Print Controls</h3>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<button
								id="print-btn"
								class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
								disabled
							>
								Print to Passbook
							</button>
							<p class="text-sm text-green-600 mt-2 text-center">
								Prints unprinted transactions to ESC-POS printer
							</p>
						</div>
						<div>
							<button
								id="next-page-btn"
								class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
								disabled
							>
								Advance to Next Page
							</button>
							<p class="text-sm text-yellow-600 mt-2 text-center">
								Use when current passbook page is full
							</p>
						</div>
					</div>
				</div>

				<!-- Print progress -->
				<div id="print-progress" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
					<h3 class="text-sm font-medium text-blue-800 mb-2">Printing Progress</h3>
					<div class="w-full bg-blue-200 rounded-full h-4 mb-2">
						<div
							id="progress-bar"
							class="bg-blue-600 h-4 rounded-full transition-all duration-300"
							style="width: 0%"
						></div>
					</div>
					<p id="progress-text" class="text-sm text-blue-700">Preparing...</p>
				</div>

				<!-- Status log -->
				<div class="bg-gray-50 rounded-lg p-4">
					<h3 class="text-sm font-medium text-gray-800 mb-2">Activity Log</h3>
					<div
						id="status-log"
						class="h-40 overflow-y-auto bg-white border border-gray-200 rounded p-2 font-mono text-xs"
					>
						<p class="text-gray-500">Ready for printing...</p>
					</div>
				</div>

				<!-- Transaction preview table -->
				<div id="transactions-preview" class="mt-6">
					<h3 class="text-lg font-medium text-gray-800 mb-4">Transactions to Print</h3>
					<div class="overflow-x-auto">
						<table class="min-w-full table-auto border-collapse">
							<thead>
								<tr class="bg-gray-100 border-b">
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Line</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Date</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Description</th>
									<th class="px-4 py-2 text-right text-xs font-medium text-gray-700">Debit</th>
									<th class="px-4 py-2 text-right text-xs font-medium text-gray-700">Credit</th>
									<th class="px-4 py-2 text-right text-xs font-medium text-gray-700">Balance</th>
									<th class="px-4 py-2 text-center text-xs font-medium text-gray-700">Status</th>
								</tr>
							</thead>
							<tbody id="transactions-tbody" class="divide-y divide-gray-200">
								<tr>
									<td colspan="7" class="px-4 py-4 text-center text-gray-500">
										Loading transactions...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<div layout:fragment="script">
			<script th:src="@{/js/escpos-printer.bundle.js}"></script>
			<script th:inline="javascript">
				/*<![CDATA[*/
				const accountId = /*[[${account.id}]]*/ "";

				// Initialize print manager
				const printManager = new PassbookPrinter.PassbookPrintManager();
				let printData = null;

				// DOM elements
				const browserWarning = document.getElementById("browser-warning");
				const browserWarningText = document.getElementById("browser-warning-text");
				const printerStatusIcon = document.getElementById("printer-status-icon");
				const printerStatusText = document.getElementById("printer-status-text");
				const connectBtn = document.getElementById("connect-printer-btn");
				const printBtn = document.getElementById("print-btn");
				const nextPageBtn = document.getElementById("next-page-btn");
				const refreshStatusBtn = document.getElementById("refresh-status-btn");
				const statusLog = document.getElementById("status-log");
				const printProgress = document.getElementById("print-progress");
				const progressBar = document.getElementById("progress-bar");
				const progressText = document.getElementById("progress-text");
				const transactionsTbody = document.getElementById("transactions-tbody");

				// Check browser compatibility
				async function checkCompatibility() {
					const compat = await printManager.checkCompatibility();
					if (!compat.supported) {
						browserWarning.classList.remove("hidden");
						browserWarningText.textContent = compat.message;
						connectBtn.disabled = true;
						return false;
					}
					// Hide warning if supported
					browserWarning.classList.add("hidden");
					return true;
				}

				// Log message
				function logMessage(message, type = "info") {
					const timestamp = new Date().toLocaleTimeString();
					const colorClass =
						{
							info: "text-gray-600",
							success: "text-green-600",
							warning: "text-yellow-600",
							error: "text-red-600",
						}[type] || "text-gray-600";

					const p = document.createElement("p");
					p.className = colorClass;
					p.textContent = `[${timestamp}] ${message}`;
					statusLog.insertBefore(p, statusLog.firstChild);
				}

				// Update printer status UI
				function updatePrinterStatus(connected) {
					if (connected) {
						printerStatusIcon.classList.remove("bg-gray-300", "bg-red-500");
						printerStatusIcon.classList.add("bg-green-500");
						printerStatusText.textContent = "Connected to ESC-POS Printer";
						connectBtn.textContent = "Disconnect";
						printBtn.disabled = !printData || printData.transactions?.length === 0;
					} else {
						printerStatusIcon.classList.remove("bg-green-500");
						printerStatusIcon.classList.add("bg-gray-300");
						printerStatusText.textContent = "Not connected";
						connectBtn.textContent = "Connect Printer";
						printBtn.disabled = true;
					}
				}

				// Update passbook status
				function updatePassbookStatus(status) {
					document.getElementById("passbook-number").textContent = status.passbookNumber || "Not issued";
					document.getElementById("current-page").textContent = status.currentPage || "-";
					document.getElementById("last-printed-line").textContent = status.lastPrintedLine || "0";
					document.getElementById("remaining-lines").textContent = status.remainingLines || "-";
					document.getElementById(
						"unprinted-count"
					).textContent = `${status.unprintedTransactionCount} transaction(s) pending print`;
				}

				// Load print data
				async function loadPrintData() {
					try {
						logMessage("Fetching print data...");
						printData = await printManager.fetchPrintData(accountId);

						if (printData.error) {
							logMessage(printData.error, "warning");
							transactionsTbody.innerHTML = `
								                         <tr>
								                             <td colspan="7" class="px-4 py-4 text-center text-gray-500">${printData.error}</td>
								                         </tr>
								                     `;
							return;
						}

						// Update passbook status
						if (printData.passbook) {
							updatePassbookStatus({
								passbookNumber: printData.passbook.passbookNumber,
								currentPage: printData.passbook.currentPage,
								lastPrintedLine: printData.passbook.lastPrintedLine,
								remainingLines: printData.passbook.remainingLines,
								unprintedTransactionCount: printData.transactions?.length || 0,
							});
						}

						// Populate transactions table
						if (printData.transactions && printData.transactions.length > 0) {
							transactionsTbody.innerHTML = printData.transactions
								.map(
									(tx) => `
								                         <tr id="tx-row-${tx.id}" class="hover:bg-gray-50">
								                             <td class="px-4 py-2 text-xs text-gray-900">${tx.lineNumber}</td>
								                             <td class="px-4 py-2 text-xs text-gray-900">${formatDate(tx.transactionDate)}</td>
								                             <td class="px-4 py-2 text-xs text-gray-900">${tx.description || ""}</td>
								                             <td class="px-4 py-2 text-xs text-right ${tx.debit ? "text-red-600" : ""}">${
										tx.debit ? formatAmount(tx.debit) : ""
									}</td>
								                             <td class="px-4 py-2 text-xs text-right ${tx.credit ? "text-green-600" : ""}">${
										tx.credit ? formatAmount(tx.credit) : ""
									}</td>
								                             <td class="px-4 py-2 text-xs text-right font-medium">${formatAmount(tx.balance)}</td>
								                             <td class="px-4 py-2 text-xs text-center">
								                                 <span id="tx-status-${
																		tx.id
																	}" class="px-2 py-1 rounded-full bg-gray-100 text-gray-600">Pending</span>
								                             </td>
								                         </tr>
								                     `
								)
								.join("");

							logMessage(`Found ${printData.transactions.length} transactions to print`, "success");

							if (printManager.isConnected()) {
								printBtn.disabled = false;
							}
						} else {
							transactionsTbody.innerHTML = `
								                         <tr>
								                             <td colspan="7" class="px-4 py-4 text-center text-gray-500">No transactions to print</td>
								                         </tr>
								                     `;
						}
					} catch (error) {
						logMessage("Error loading print data: " + error.message, "error");
					}
				}

				// Format date
				function formatDate(dateString) {
					const date = new Date(dateString);
					return date.toLocaleDateString("id-ID", { day: "2-digit", month: "2-digit", year: "numeric" });
				}

				// Format amount
				function formatAmount(amount) {
					if (amount === null || amount === undefined) return "";
					return new Intl.NumberFormat("id-ID", {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					}).format(amount);
				}

				// Connect to printer
				async function connectPrinter() {
					if (printManager.isConnected()) {
						await printManager.disconnectPrinter();
						updatePrinterStatus(false);
						logMessage("Disconnected from printer");
						return;
					}

					try {
						logMessage("Connecting to printer...");
						await printManager.connectPrinter();
						updatePrinterStatus(true);
						logMessage("Connected to ESC-POS Printer", "success");

						if (printData && printData.transactions?.length > 0) {
							printBtn.disabled = false;
						}
					} catch (error) {
						logMessage("Failed to connect: " + error.message, "error");
						updatePrinterStatus(false);
					}
				}

				// Print transactions
				async function printTransactions() {
					if (!printData || !printData.transactions || printData.transactions.length === 0) {
						logMessage("No transactions to print", "warning");
						return;
					}

					printBtn.disabled = true;
					printProgress.classList.remove("hidden");

					try {
						const result = await printManager.printPassbook(
							accountId,
							// Progress callback
							(progress) => {
								const percent = Math.round((progress.current / progress.total) * 100);
								progressBar.style.width = percent + "%";
								progressText.textContent = `Printing transaction ${progress.current} of ${progress.total}`;

								// Update row status
								const statusEl = document.getElementById(`tx-status-${progress.transaction.id}`);
								if (statusEl) {
									statusEl.className = "px-2 py-1 rounded-full bg-green-100 text-green-600";
									statusEl.textContent = "Printed";
								}
							},
							// Status callback
							(status) => {
								logMessage(status.message, status.type);
							}
						);

						if (result.success) {
							progressText.textContent = "Print completed!";
							progressBar.style.width = "100%";

							// Reload data after successful print
							setTimeout(() => {
								loadPrintData();
								printProgress.classList.add("hidden");
							}, 2000);
						}
					} catch (error) {
						logMessage("Print failed: " + error.message, "error");
						progressText.textContent = "Print failed";
						progressBar.classList.remove("bg-blue-600");
						progressBar.classList.add("bg-red-600");
					}
				}

				// Advance to next page
				async function advanceToNextPage() {
					try {
						logMessage("Advancing to next page...");
						const result = await printManager.advanceToNextPage(accountId);

						if (result.success) {
							logMessage(`Advanced to page ${result.currentPage}`, "success");
							await loadPrintData();
						}
					} catch (error) {
						logMessage("Failed to advance page: " + error.message, "error");
					}
				}

				// Initialize
				document.addEventListener("DOMContentLoaded", async function () {
					const isCompatible = await checkCompatibility();
					if (!isCompatible) {
						return;
					}
					const connectBtn = document.getElementById("connect-printer-btn");
					const printBtn = document.getElementById("print-btn");
					const nextPageBtn = document.getElementById("next-page-btn");
					const refreshStatusBtn = document.getElementById("refresh-status-btn");

					// Event listeners
					connectBtn.addEventListener("click", connectPrinter);
					printBtn.addEventListener("click", printTransactions);
					nextPageBtn.addEventListener("click", advanceToNextPage);
					refreshStatusBtn.addEventListener("click", loadPrintData);

					// Enable next page button
					nextPageBtn.disabled = false;

					// Load initial data
					await loadPrintData();

					logMessage("Ready for printing", "success");
				});
				/*]]>*/
			</script>
		</div>
	</body>
</html>
