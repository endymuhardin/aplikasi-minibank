<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passbook - <span th:text="${account.accountNumber}">Account</span> - <span th:text="${bankName}">Bank</span></title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <style>
        /* Print-specific styles */
        @media print {
            @page {
                size: A4;
                margin: 0.5in;
            }
            
            body {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                font-family: 'Courier New', monospace;
                font-size: 11px;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .page-break-avoid {
                page-break-inside: avoid;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 4px 6px;
                text-align: left;
                vertical-align: top;
            }
            
            .text-right {
                text-align: right;
            }
            
            .text-center {
                text-align: center;
            }
            
            .font-bold {
                font-weight: bold;
            }
            
            .bg-gray-100 {
                background-color: #f5f5f5 !important;
            }
            
            .passbook-header {
                border: 2px solid #000;
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .passbook-logo {
                width: 60px;
                height: 60px;
                object-fit: contain;
            }
        }
        
        /* Screen styles */
        @media screen {
            .print-only {
                display: none;
            }
            
            .passbook-container {
                max-width: 21cm;
                margin: 0 auto;
                background: white;
                padding: 1rem;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }
            
            .passbook-logo {
                width: 80px;
                height: 80px;
                object-fit: contain;
            }
        }
        
        /* Common styles */
        .passbook-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #333;
        }
        
        .bank-info {
            flex-grow: 1;
            margin-left: 15px;
        }
        
        .account-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #333;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .transactions-table th,
        .transactions-table td {
            border: 1px solid #333;
            padding: 6px 8px;
            font-size: 10px;
        }
        
        .transactions-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        .amount-credit {
            color: #059669;
        }
        
        .amount-debit {
            color: #DC2626;
        }
        
        .footer-info {
            margin-top: 30px;
            padding: 10px;
            border: 1px solid #333;
            font-size: 9px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Print controls (hidden when printing) -->
    <div class="no-print bg-white shadow-lg p-4 mb-4 rounded-lg max-w-4xl mx-auto">
        <div class="flex justify-between items-center">
            <div>
                <h1 id="page-title" class="text-xl font-bold text-gray-800">Passbook Print View</h1>
                <p class="text-sm text-gray-600">Account: <span th:text="${account.accountNumber}">A2000001</span></p>
            </div>
            <div class="flex space-x-2">
                <a th:href="@{/passbook/preview/{id}(id=${account.id})}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Back to Preview
                </a>
                <button id="printButton" onclick="window.print()" 
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    üñ®Ô∏è Print Passbook
                </button>
            </div>
        </div>
        <!-- Browser compatibility info -->
        <div class="mt-3 text-xs text-gray-500">
            <p><strong>Print Tips:</strong> For best results, use Chrome or Firefox. Ensure "More settings" ‚Üí "Print headers and footers" is disabled.</p>
        </div>
    </div>
    
    <!-- Passbook content -->
    <div class="passbook-container">
        <!-- Header with bank logo and info -->
        <div class="passbook-header page-break-avoid">
            <div class="flex-shrink-0">
                <img th:src="@{${bankLogoPath}}" 
                     alt="Bank Logo" 
                     class="passbook-logo"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display:none; width:80px; height:80px; background:#e5e7eb; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6b7280;">
                    BANK<br>LOGO
                </div>
            </div>
            <div class="bank-info">
                <h1 class="text-xl font-bold" th:text="${bankName}">Minibank Islamic Banking</h1>
                <p class="text-sm" th:text="${bankAddress}">Jl. Raya Jakarta No. 123, Jakarta 12345</p>
                <p class="text-lg font-bold mt-2">BUKU TABUNGAN / PASSBOOK</p>
            </div>
            <div class="flex-shrink-0 text-right">
                <p class="text-sm">Print Date:</p>
                <p class="font-bold" th:text="${#temporals.format(printDate, 'dd/MM/yyyy')}">01/01/2024</p>
            </div>
        </div>
        
        <!-- Account information -->
        <div class="account-info-grid page-break-avoid">
            <div>
                <p><strong>Account Number:</strong> <span th:text="${account.accountNumber}">A2000001</span></p>
                <p><strong>Account Name:</strong> <span th:text="${account.accountName}">Account Name</span></p>
                <p><strong>Product Type:</strong> <span th:text="${account.product.productName}">Product Name</span></p>
                <p><strong>Opened Date:</strong> <span th:text="${#temporals.format(account.openedDate, 'dd/MM/yyyy')}">01/01/2024</span></p>
            </div>
            <div>
                <p><strong>Customer Name:</strong> <span th:text="${account.customer.displayName}">Customer Name</span></p>
                <p><strong>Customer Number:</strong> <span th:text="${account.customer.customerNumber}">C1000001</span></p>
                <p><strong>Current Balance:</strong> 
                    <span class="font-bold">IDR <span th:text="${#numbers.formatDecimal(account.balance, 0, 'COMMA', 2, 'POINT')}">0.00</span></span>
                </p>
                <p><strong>Account Status:</strong> <span th:text="${account.status.name()}">ACTIVE</span></p>
            </div>
        </div>
        
        <!-- Date filter info (if applied) -->
        <div th:if="${fromDate != null or toDate != null}" class="no-print bg-blue-50 border border-blue-200 p-3 mb-4 rounded">
            <p class="text-sm font-medium">Transaction Filter Applied:</p>
            <p class="text-sm">
                <span th:if="${fromDate != null}">From: <span th:text="${fromDate}">2024-01-01</span></span>
                <span th:if="${fromDate != null and toDate != null}"> | </span>
                <span th:if="${toDate != null}">To: <span th:text="${toDate}">2024-12-31</span></span>
            </p>
        </div>
        
        <!-- Transactions table -->
        <div th:if="${transactions.content}">
            <table class="transactions-table">
                <thead>
                    <tr class="bg-gray-100">
                        <th style="width: 12%">Date</th>
                        <th style="width: 20%">Description</th>
                        <th style="width: 15%">Transaction No.</th>
                        <th style="width: 10%">Type</th>
                        <th style="width: 15%">Debit</th>
                        <th style="width: 15%">Credit</th>
                        <th style="width: 13%">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="transaction : ${transactions.content}">
                        <td class="text-center">
                            <span th:text="${#temporals.format(transaction.transactionDate, 'dd/MM/yyyy')}">01/01/2024</span><br>
                            <span class="text-xs" th:text="${#temporals.format(transaction.transactionDate, 'HH:mm')}">10:00</span>
                        </td>
                        <td>
                            <span th:text="${transaction.description}">Transaction description</span>
                            <span th:if="${transaction.referenceNumber != null}">
                                <br><small th:text="${transaction.referenceNumber}">REF123</small>
                            </span>
                        </td>
                        <td class="text-center text-xs">
                            <span th:text="${transaction.transactionNumber}">TXN0000001</span>
                        </td>
                        <td class="text-center text-xs">
                            <span th:text="${transaction.transactionType.name()}">DEPOSIT</span><br>
                            <small th:text="${transaction.channel.name()}">TELLER</small>
                        </td>
                        <td class="text-right">
                            <span th:if="${transaction.isDebitTransaction()}" class="amount-debit">
                                <span th:text="${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                            </span>
                        </td>
                        <td class="text-right">
                            <span th:if="${transaction.isCreditTransaction()}" class="amount-credit">
                                <span th:text="${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                            </span>
                        </td>
                        <td class="text-right font-bold">
                            <span th:text="${#numbers.formatDecimal(transaction.balanceAfter, 0, 'COMMA', 2, 'POINT')}">0.00</span>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Pagination info for print -->
            <div th:if="${transactions.totalPages > 1}" class="text-center text-xs mb-4">
                Page <span th:text="${transactions.number + 1}">1</span> of <span th:text="${transactions.totalPages}">1</span> | 
                Total Transactions: <span th:text="${transactions.totalElements}">0</span>
            </div>
        </div>
        
        <!-- Empty state -->
        <div th:if="${transactions.content.empty}" class="text-center py-8">
            <h3 class="text-lg font-medium text-gray-900 mb-2">No transactions found</h3>
            <p class="text-gray-500">
                <span th:if="${fromDate != null or toDate != null}">No transactions found for the selected date range.</span>
                <span th:unless="${fromDate != null or toDate != null}">This account has no transaction history.</span>
            </p>
        </div>
        
        <!-- Footer information -->
        <div class="footer-info page-break-avoid">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p><strong>Generated by:</strong> <span th:text="${bankName}">Minibank Islamic Banking</span></p>
                    <p><strong>Print Date:</strong> <span th:text="${#temporals.format(printDate, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span></p>
                    <p class="print-only"><strong>This document is computer generated and does not require signature.</strong></p>
                </div>
                <div class="text-right">
                    <p><strong>Customer Service:</strong> 1500-xxx</p>
                    <p><strong>Website:</strong> www.minibank.co.id</p>
                    <p><strong>Email:</strong> info@minibank.co.id</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Print functionality with browser compatibility
        document.addEventListener('DOMContentLoaded', function() {
            const printButton = document.getElementById('printButton');
            
            // Detect browser for better compatibility
            function detectBrowser() {
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isFirefox = /Firefox/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                
                return { isChrome, isFirefox, isSafari, isEdge };
            }
            
            // Enhanced print function
            function printPassbook() {
                const browser = detectBrowser();
                
                // Focus window before printing (helps with some browsers)
                window.focus();
                
                // Small delay to ensure page is fully rendered
                setTimeout(() => {
                    try {
                        // For better compatibility, especially with Firefox
                        if (browser.isFirefox) {
                            window.print();
                        } else {
                            // Use standard print for Chrome, Edge, Safari
                            window.print();
                        }
                    } catch (error) {
                        console.error('Print error:', error);
                        alert('Unable to print. Please use your browser\'s print function (Ctrl+P or Cmd+P).');
                    }
                }, 100);
            }
            
            // Bind print button
            if (printButton) {
                printButton.addEventListener('click', printPassbook);
            }
            
            // Handle keyboard shortcut
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    printPassbook();
                }
            });
            
            // Auto-adjust print settings recommendation
            const browser = detectBrowser();
            if (browser.isFirefox) {
                console.log('Firefox detected: For best print results, disable headers/footers in print settings.');
            } else if (browser.isChrome) {
                console.log('Chrome detected: For best print results, disable headers/footers in "More settings".');
            }
        });
        
        // Print event handlers for debugging
        window.addEventListener('beforeprint', function() {
            console.log('Preparing to print passbook...');
        });
        
        window.addEventListener('afterprint', function() {
            console.log('Print dialog closed.');
        });
    </script>
</body>
</html>