---
- name: Deploy Minibank Islamic Banking Application
  hosts: minibank_servers
  become: yes
  vars_files:
    - vars/deploy-vars.yml

  tasks:
    - name: Verify SSH connection
      ping:
      tags: always

    - name: Display deployment information
      debug:
        msg:
          - "Deploying {{ app_name }}"
          - "Target directory: {{ app_install_dir }}"
          - "JAR file: {{ app_jar_name }}"
          - "User: {{ app_user }}"
      tags: always

    - name: Ensure application directory exists
      file:
        path: "{{ app_install_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
      tags: prepare

    - name: Ensure backup directory exists
      file:
        path: "{{ app_backup_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
      tags: prepare

    - name: Check if JAR file exists locally
      stat:
        path: "{{ local_jar_path }}"
      delegate_to: localhost
      become: no
      register: local_jar_stat
      tags: build

    - name: Fail if JAR file not found
      fail:
        msg: "JAR file not found at {{ local_jar_path }}. Please run 'mvn clean package' first."
      when: not local_jar_stat.stat.exists
      tags: build

    - name: Display JAR file information
      debug:
        msg:
          - "Local JAR: {{ local_jar_path }}"
          - "Size: {{ (local_jar_stat.stat.size / 1024 / 1024) | round(2) }} MB"
          - "Modified: {{ local_jar_stat.stat.mtime }}"
      when: local_jar_stat.stat.exists
      tags: build

    - name: Check if application is currently running
      systemd:
        name: "{{ service_name }}"
      register: service_status
      ignore_errors: yes
      tags: deploy

    - name: Stop application service if running
      systemd:
        name: "{{ service_name }}"
        state: stopped
      when: service_status.status is defined and service_status.status.ActiveState == "active"
      tags: deploy

    - name: Backup current JAR file if exists
      copy:
        src: "{{ app_install_dir }}/{{ app_jar_name }}"
        dest: "{{ app_backup_dir }}/{{ app_jar_name }}.{{ ansible_date_time.iso8601_basic_short }}"
        remote_src: yes
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
      when: service_status.status is defined
      ignore_errors: yes
      tags: deploy

    - name: Copy new JAR file to server
      copy:
        src: "{{ local_jar_path }}"
        dest: "{{ app_install_dir }}/{{ app_jar_name }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
      tags: deploy

    - name: Create/update symlink to JAR file
      file:
        src: "{{ app_install_dir }}/{{ app_jar_name }}"
        dest: "{{ app_install_dir }}/{{ app_symlink_name }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        state: link
        force: yes
      tags: deploy

    - name: Deploy systemd service file
      template:
        src: templates/minibank.service.j2
        dest: /etc/systemd/system/{{ service_name }}.service
        owner: root
        group: root
        mode: '0644'
      notify: reload systemd
      tags: service

    - name: Ensure systemd is reloaded
      systemd:
        daemon_reload: yes
      tags: service

    - name: Enable and start application service
      systemd:
        name: "{{ service_name }}"
        enabled: "{{ service_enabled }}"
        state: "{{ service_state }}"
      tags: service

    - name: Wait for application to be ready
      wait_for:
        port: "{{ server_port }}"
        delay: 5
        timeout: 60
        msg: "Application failed to start on port {{ server_port }}"
      tags: verify

    - name: Check application health
      uri:
        url: "http://localhost:{{ server_port }}/actuator/health"
        method: GET
        return_content: yes
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 10
      ignore_errors: yes
      tags: verify

    - name: Display application status
      debug:
        msg:
          - "Application deployment completed!"
          - "Service status: {{ service_state }}"
          - "Port: {{ server_port }}"
          - "Health check: {{ health_check.json.status if health_check.json is defined else 'No actuator endpoint' }}"
      tags: verify

    - name: Cleanup old backups
      shell: |
        find {{ app_backup_dir }} -name "{{ app_jar_name }}.*" -type f -mtime +{{ backup_retention_days }} -delete
        ls -t {{ app_backup_dir }}/{{ app_jar_name }}.* 2>/dev/null | tail -n +{{ max_backups + 1 }} | xargs -r rm
      args:
        executable: /bin/bash
      tags: cleanup

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
