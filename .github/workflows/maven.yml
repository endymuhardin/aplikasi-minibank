name: Java CI with Maven and Documentation Generation

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: maven
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: mvn -B compile --file pom.xml
      
    - name: Run unit and integration tests
      run: mvn -B test --file pom.xml -Dtest.profile=parallel
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/

  documentation-generation:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: maven
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Install system dependencies
      run: |
        # Update package lists
        sudo apt-get update
        
        # Install basic dependencies and updated package names for Ubuntu 24.04
        sudo apt-get install -y \
          xvfb \
          pandoc \
          wget \
          unzip \
          fonts-liberation \
          libasound2t64 \
          libatk-bridge2.0-0 \
          libatk1.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libxss1 \
          libgtk-3-0 \
          libgbm1 \
          xdg-utils
        
        echo "‚úÖ System dependencies installed successfully"
        
    - name: Compile application
      run: mvn -B compile --file pom.xml
      
    - name: Generate Playwright documentation with headless mode
      run: |
        echo "üöÄ Generating user documentation with Playwright..."
        # Set up virtual display for headless browser testing
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
        # Wait for Xvfb to start
        sleep 3
        
        # Check available browsers and system info
        echo "üìã System information:"
        uname -a
        echo "üñ•Ô∏è Display: $DISPLAY"
        ps aux | grep Xvfb || echo "Xvfb not running"
        
        # Run customer onboarding documentation test in headless mode for CI
        echo "üß™ Starting Playwright customer onboarding test..."
        mvn test -Dtest=ApprovalWorkflowTutorialTest \
          -Dplaywright.headless=true \
          -Dplaywright.slowmo=1000 \
          -Dplaywright.record=true \
          -Dplaywright.browser=chromium \
          -X || {
            echo "‚ùå Test failed, checking logs..."
            find target -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || true
            exit 1
          }
          
    - name: Generate customer onboarding documentation from screenshots and videos
      run: |
        echo "üìö Generating customer onboarding documentation from captured media..."
        mvn exec:java -Dexec.mainClass="id.ac.tazkia.minibank.util.ApprovalWorkflowDocGenerator"

        echo "üìÇ Documentation already generated in docs/user-manual by ApprovalWorkflowDocGenerator"
        echo "‚úÖ Documentation available at docs/user-manual/"
        
    - name: Prepare documentation for deployment
      run: |
        echo "üì¶ Preparing documentation for GitHub Pages..."
        
        # Create pages directory
        mkdir -p pages
        
        # Copy documentation to pages directory
        cp -r docs/user-manual/* pages/
        
        # Create main index.html with delayed redirect and better UX
        cat > pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="id">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Aplikasi Minibank - Dokumentasi Pengguna</title>
            <style>
                body { 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                    text-align: center; 
                    padding: 20px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    min-height: 100vh;
                    margin: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    padding: 40px;
                    border-radius: 15px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                    max-width: 600px;
                    width: 90%;
                }
                h1 { 
                    margin-bottom: 20px; 
                    font-size: 2.5em;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                }
                p { 
                    font-size: 1.2em; 
                    margin-bottom: 20px;
                }
                .redirect-link {
                    display: inline-block;
                    padding: 15px 30px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    border-radius: 8px;
                    border: 2px solid rgba(255,255,255,0.3);
                    transition: all 0.3s ease;
                    font-weight: bold;
                    margin: 10px;
                }
                .redirect-link:hover {
                    background: rgba(255,255,255,0.3);
                    transform: translateY(-2px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                }
                .countdown {
                    font-size: 0.9em;
                    opacity: 0.8;
                    margin-top: 20px;
                }
                #countdown-timer {
                    font-weight: bold;
                    color: #ffeb3b;
                }
        EOF
        
        # Complete the index.html with better content and JavaScript
        echo "                .timestamp { font-size: 0.9em; margin-top: 30px; opacity: 0.8; }" >> pages/index.html
        echo "            </style>" >> pages/index.html
        echo "        </head>" >> pages/index.html
        echo "        <body>" >> pages/index.html
        echo "            <div class=\"container\">" >> pages/index.html
        echo "                <h1>üè¶ Aplikasi Minibank</h1>" >> pages/index.html
        echo "                <p>Dokumentasi Pengguna - Sistem Perbankan Syariah</p>" >> pages/index.html
        echo "                <p>Panduan lengkap Proses Onboarding Nasabah Baru untuk CS, Branch Manager, dan Teller</p>" >> pages/index.html
        echo "                " >> pages/index.html
        echo "                <a href=\"panduan-customer-onboarding.html\" class=\"redirect-link\">üìö Buka Panduan Proses Onboarding Nasabah Baru</a>" >> pages/index.html
        echo "                <a href=\"README.html\" class=\"redirect-link\">üìã Lihat Daftar Panduan</a>" >> pages/index.html
        echo "                " >> pages/index.html
        echo "                <div class=\"countdown\">" >> pages/index.html
        echo "                    Otomatis menuju panduan dalam <span id=\"countdown-timer\">10</span> detik" >> pages/index.html
        echo "                    <br><small>Klik tombol di atas untuk langsung membuka</small>" >> pages/index.html
        echo "                </div>" >> pages/index.html
        
        # Add timestamp
        echo "                <div class=\"timestamp\">üìÖ Diperbarui: $(date '+%d %B %Y %H:%M WIB')</div>" >> pages/index.html
        
        # Add closing tags and JavaScript
        echo "            </div>" >> pages/index.html
        echo "            " >> pages/index.html
        echo "            <script>" >> pages/index.html
        echo "                let countdown = 10;" >> pages/index.html
        echo "                const timer = document.getElementById('countdown-timer');" >> pages/index.html
        echo "                " >> pages/index.html
        echo "                const interval = setInterval(() => {" >> pages/index.html
        echo "                    countdown--;" >> pages/index.html
        echo "                    timer.textContent = countdown;" >> pages/index.html
        echo "                    " >> pages/index.html
        echo "                    if (countdown <= 0) {" >> pages/index.html
        echo "                        clearInterval(interval);" >> pages/index.html
        echo "                        window.location.href = 'panduan-customer-onboarding.html';" >> pages/index.html
        echo "                    }" >> pages/index.html
        echo "                }, 1000);" >> pages/index.html
        echo "                " >> pages/index.html
        echo "                document.addEventListener('click', () => {" >> pages/index.html
        echo "                    clearInterval(interval);" >> pages/index.html
        echo "                    timer.parentElement.innerHTML = 'Otomatis redirect dibatalkan - klik tombol untuk navigasi manual';" >> pages/index.html
        echo "                });" >> pages/index.html
        echo "            </script>" >> pages/index.html
        echo "        </body>" >> pages/index.html
        echo "        </html>" >> pages/index.html
        
        # Convert markdown to HTML for better web display with responsive images
        if command -v pandoc > /dev/null; then
            echo "üîÑ Converting Markdown to HTML..."
            
            # Create custom CSS file for responsive images and better styling
            touch pages/custom-styles.css
            echo "/* Custom styles for user manual */" > pages/custom-styles.css
            echo ".container { max-width: 1200px; margin: 0 auto; padding: 20px; }" >> pages/custom-styles.css
            echo "" >> pages/custom-styles.css
            echo "/* Responsive images */" >> pages/custom-styles.css
            echo "img { max-width: 100%; height: auto; margin: 15px 0; border: 2px solid #e9ecef; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin-left: auto; margin-right: auto; }" >> pages/custom-styles.css
            echo "" >> pages/custom-styles.css
            echo "/* Limit image width on larger screens */" >> pages/custom-styles.css
            echo "@media (min-width: 768px) { img { max-width: 80%; } }" >> pages/custom-styles.css
            echo "@media (min-width: 992px) { img { max-width: 70%; } }" >> pages/custom-styles.css
            echo "" >> pages/custom-styles.css
            echo "/* Style for code blocks */" >> pages/custom-styles.css
            echo "pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 4px solid #007bff; }" >> pages/custom-styles.css
            echo "code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }" >> pages/custom-styles.css
            echo "" >> pages/custom-styles.css
            echo "/* Header styling */" >> pages/custom-styles.css
            echo "h1, h2, h3 { color: #495057; margin-top: 2rem; margin-bottom: 1rem; }" >> pages/custom-styles.css
            echo "h1 { border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; }" >> pages/custom-styles.css
            echo "h2 { border-bottom: 1px solid #dee2e6; padding-bottom: 0.3rem; }" >> pages/custom-styles.css
            echo "h3 { background: #e3f2fd; padding: 10px 15px; border-radius: 5px; border-left: 4px solid #2196f3; }" >> pages/custom-styles.css
            echo "" >> pages/custom-styles.css
            echo "/* Video links */" >> pages/custom-styles.css
            echo "a[href$='.webm'] { display: inline-block; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; margin: 5px 0; }" >> pages/custom-styles.css
            echo "a[href$='.webm']:hover { background: #218838; }" >> pages/custom-styles.css

            # Add Mermaid diagram styling
            echo "" >> pages/custom-styles.css
            echo "/* Mermaid diagrams */" >> pages/custom-styles.css
            echo ".mermaid { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }" >> pages/custom-styles.css
            echo "body { line-height: 1.6; }" >> pages/custom-styles.css
            echo "p { margin-bottom: 1rem; }" >> pages/custom-styles.css

            # Create header file with Mermaid support
            echo '<script type="module">' > pages/mermaid-header.html
            echo "  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';" >> pages/mermaid-header.html
            echo '  mermaid.initialize({' >> pages/mermaid-header.html
            echo '    startOnLoad: true,' >> pages/mermaid-header.html
            echo "    theme: 'default'," >> pages/mermaid-header.html
            echo "    securityLevel: 'loose'" >> pages/mermaid-header.html
            echo '  });' >> pages/mermaid-header.html
            echo '</script>' >> pages/mermaid-header.html

            # Create Lua filter for Mermaid diagrams
            printf '%s\n' 'function CodeBlock(block)' > pages/mermaid.lua
            printf '%s\n' '  if block.classes[1] == "mermaid" then' >> pages/mermaid.lua
            printf '%s\n' '    local html = "<div class=\"mermaid\">" .. block.text .. "</div>"' >> pages/mermaid.lua
            printf '%s\n' '    return pandoc.RawBlock("html", html)' >> pages/mermaid.lua
            printf '%s\n' '  end' >> pages/mermaid.lua
            printf '%s\n' 'end' >> pages/mermaid.lua

            # Create HTML with Mermaid support
            pandoc pages/panduan-customer-onboarding.md \
              -o pages/panduan-customer-onboarding.html \
              --standalone \
              --lua-filter=pages/mermaid.lua \
              --css=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css \
              --css=custom-styles.css \
              --metadata title="Panduan Proses Onboarding Nasabah Baru" \
              --toc \
              --toc-depth=3 \
              --include-in-header=pages/mermaid-header.html \
              --from markdown+hard_line_breaks \
              --to html5 \
              --wrap=preserve
        else
            echo "‚ö†Ô∏è Pandoc not available, keeping Markdown format"
            # Create a simple HTML wrapper for the markdown with responsive images
            echo "<!DOCTYPE html>" > pages/panduan-customer-onboarding.html
            echo "<html lang=\"id\">" >> pages/panduan-customer-onboarding.html
            echo "<head>" >> pages/panduan-customer-onboarding.html
            echo "<meta charset=\"UTF-8\">" >> pages/panduan-customer-onboarding.html
            echo "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">" >> pages/panduan-customer-onboarding.html
            echo "<title>Panduan Proses Onboarding Nasabah Baru</title>" >> pages/panduan-customer-onboarding.html
            echo "<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">" >> pages/panduan-customer-onboarding.html
            echo "<link rel=\"stylesheet\" href=\"custom-styles.css\">" >> pages/panduan-customer-onboarding.html
            echo "</head>" >> pages/panduan-customer-onboarding.html
            echo "<body>" >> pages/panduan-customer-onboarding.html
            echo "<div class=\"container mt-3\">" >> pages/panduan-customer-onboarding.html
            echo "<div class=\"alert alert-info\" role=\"alert\">" >> pages/panduan-customer-onboarding.html
            echo "<strong>üìö Dokumentasi Aplikasi Minibank</strong><br>" >> pages/panduan-customer-onboarding.html
            echo "Panduan ini dibuat secara otomatis menggunakan Playwright dan GitHub Actions." >> pages/panduan-customer-onboarding.html
            echo "<a href=\"README.html\" class=\"alert-link ms-2\">Lihat daftar panduan lainnya</a>" >> pages/panduan-customer-onboarding.html
            echo "</div>" >> pages/panduan-customer-onboarding.html
            echo "<iframe src=\"panduan-customer-onboarding.md\" width=\"100%\" height=\"800\" style=\"border: 1px solid #dee2e6; border-radius: 5px;\"></iframe>" >> pages/panduan-customer-onboarding.html
            echo "<div class=\"mt-3\">" >> pages/panduan-customer-onboarding.html
            echo "<a href=\"panduan-customer-onboarding.md\" class=\"btn btn-outline-primary me-2\" target=\"_blank\">üìÑ Lihat file Markdown asli</a>" >> pages/panduan-customer-onboarding.html
            echo "<a href=\"README.html\" class=\"btn btn-outline-secondary\" target=\"_blank\">üìã Kembali ke daftar panduan</a>" >> pages/panduan-customer-onboarding.html
            echo "</div>" >> pages/panduan-customer-onboarding.html
            echo "</div>" >> pages/panduan-customer-onboarding.html
            echo "</body>" >> pages/panduan-customer-onboarding.html
            echo "</html>" >> pages/panduan-customer-onboarding.html
        fi
        
        # Create README.html for better web navigation  
        echo "<!DOCTYPE html>" > pages/README.html
        echo "<html lang=\"id\">" >> pages/README.html
        echo "<head>" >> pages/README.html
        echo "<meta charset=\"UTF-8\">" >> pages/README.html
        echo "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">" >> pages/README.html
        echo "<title>Dokumentasi Pengguna - Aplikasi Minibank</title>" >> pages/README.html
        echo "<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">" >> pages/README.html
        echo "</head>" >> pages/README.html
        echo "<body>" >> pages/README.html
        echo "<div class=\"container mt-5\">" >> pages/README.html
        echo "<div class=\"row\">" >> pages/README.html
        echo "<div class=\"col-lg-8 offset-lg-2\">" >> pages/README.html
        echo "<iframe src=\"README.md\" width=\"100%\" height=\"600\" style=\"border: 1px solid #dee2e6; border-radius: 5px;\"></iframe>" >> pages/README.html
        echo "</div>" >> pages/README.html
        echo "</div>" >> pages/README.html
        echo "</div>" >> pages/README.html
        echo "</body>" >> pages/README.html
        echo "</html>" >> pages/README.html
        
        echo "‚úÖ Documentation prepared successfully!"
        
        # Show directory structure for debugging
        echo "üìÅ Pages directory structure:"
        ls -la pages/
        
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: user-documentation
        path: pages/
        retention-days: 30
        
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './pages'

  deploy-pages:
    runs-on: ubuntu-latest
    needs: documentation-generation
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
